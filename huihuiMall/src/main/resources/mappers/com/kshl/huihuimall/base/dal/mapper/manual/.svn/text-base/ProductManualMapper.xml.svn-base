<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kshl.huihuimall.base.dal.manualmapper.ProductManualMapper">
    <resultMap id="ProductBaseResultMap" type="com.kshl.huihuimall.base.dal.entity.Product">
        <id column="id" jdbcType="INTEGER" property="id" />
        <result column="shelves_status" jdbcType="INTEGER" property="shelvesStatus" />
        <result column="offshelves_date" jdbcType="TIMESTAMP" property="offshelvesDate" />
        <result column="shelves_date" jdbcType="TIMESTAMP" property="shelvesDate" />
        <result column="categoryone_id" jdbcType="INTEGER" property="categoryoneId" />
        <result column="categorytwo_id" jdbcType="INTEGER" property="categorytwoId" />
        <result column="code" jdbcType="VARCHAR" property="code" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="brand_id" jdbcType="INTEGER" property="brandId" />
        <result column="specifications" jdbcType="VARCHAR" property="specifications" />
        <result column="measurement_unit" jdbcType="VARCHAR" property="measurementUnit" />
        <result column="packing" jdbcType="VARCHAR" property="packing" />
        <result column="weight" jdbcType="VARCHAR" property="weight" />
        <result column="purchase_price" jdbcType="DECIMAL" property="purchasePrice" />
        <result column="packing_price" jdbcType="DECIMAL" property="packingPrice" />
        <result column="material_price" jdbcType="DECIMAL" property="materialPrice" />
        <result column="transport_price" jdbcType="DECIMAL" property="transportPrice" />
        <result column="place_of_origin" jdbcType="VARCHAR" property="placeOfOrigin" />
        <result column="price" jdbcType="DECIMAL" property="price" />
        <result column="trade_price" jdbcType="DECIMAL" property="tradePrice" />
        <result column="stock_location" jdbcType="INTEGER" property="stockLocation" />
        <result column="main_image_path" jdbcType="VARCHAR" property="mainImagePath" />
        <result column="merchant_id" jdbcType="INTEGER" property="merchantId" />
        <result column="review_status" jdbcType="INTEGER" property="reviewStatus" />
        <result column="merchant_type" jdbcType="INTEGER" property="merchantType" />
        <result column="date_manufacture" jdbcType="TIMESTAMP" property="dateManufacture" />
        <result column="guarantee_date" jdbcType="INTEGER" property="guaranteeDate" />
        <result column="expiration_date" jdbcType="TIMESTAMP" property="expirationDate" />
        <result column="Remarks" jdbcType="VARCHAR" property="remarks" />
    </resultMap>

    <select id="getAllProduct" parameterType="map" resultType="map">
        SELECT
        p.*, b.name AS brandname, co.name AS categoryonename, ct.name AS categorytwoname,
        m.name AS merchantname
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        WHERE p.merchant_type=2
            <if test="brandid != null">
                AND p.brand_id = #{brandid}
            </if>
            <if test="categoryoneid != null">
                AND p.categoryone_id = #{categoryoneid}
            </if>
            <if test="categorytwoid != null">
                AND p.categorytwo_id = #{categorytwoid}
            </if>
            <if test="name != null">
                AND p.name LIKE CONCAT('%','${name}', '%')
            </if>
            <if test="shelvesstatus != null">
                AND p.shelves_status = #{shelvesstatus}
            </if>
            <if test="merchantid != null">
                AND p.merchant_id = #{merchantid}
            </if>
        ORDER BY FIELD (p.shelves_status,1,0,2) ,p.shelves_date desc
        <if test="startPage != null and pageSize != null">
            LIMIT #{startPage,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>

    <select id="getAllProductCount" parameterType="map" resultType="Integer">
        SELECT
        COUNT(*)
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        WHERE p.merchant_type=2
            <if test="brandid != null">
                AND p.brand_id = #{brandid}
            </if>
            <if test="categoryoneid != null">
                AND p.categoryone_id = #{categoryoneid}
            </if>
            <if test="categorytwoid != null">
                AND p.categorytwo_id = #{categorytwoid}
            </if>
            <if test="name != null">
                AND p.name LIKE CONCAT('%','${name}', '%')
            </if>
            <if test="shelvesstatus != null">
                AND p.shelves_status = #{shelvesstatus}
            </if>
            <if test="merchantid != null">
                AND p.merchant_id = #{merchantid}
            </if>
    </select>

    <select id="getAllProductReview" parameterType="map" resultType="map">
        SELECT p.*, b.name AS brandname, co.name AS categoryonename, ct.name AS categorytwoname,
        m.name AS merchantname, pr.time AS applytime
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        LEFT JOIN product_review AS pr ON pr.product_id = p.id
        WHERE p.merchant_id IS NOT NULL
        <if test="name != null">
            AND p.name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="startPage != null and pageSize != null">
            LIMIT #{startPage,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>

    <select id="getAllProductReviewCount" parameterType="map" resultType="Integer">
        SELECT COUNT(p.*)
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        LEFT JOIN product_review AS pr ON pr.product_id = p.id
        WHERE p.merchant_id IS NOT NULL
        <if test="name != null">
            AND p.name LIKE CONCAT('%', #{name}, '%')
        </if>
    </select>

    <select id="getproductbyCode" parameterType="java.lang.String" resultType="com.kshl.huihuimall.base.dal.entity.Product">
        SELECT *FROM product where code LIKE CONCAT('%', #{productCode}, '%')
    </select>

    <select id="queryShelvesReviewMg" parameterType="map" resultType="map">
       SELECT *
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        <trim prefix="where" prefixOverrides="and|or">
            <if test="id != null">
                AND m.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="auditStatus != null">
                AND p.review_status =#{auditStatus,jdbcType=INTEGER}
            </if>
            <if test="shelveStatus != null">
                AND p.shelves_status =#{shelveStatus,jdbcType=INTEGER}
            </if>
        </trim>
        <if test="startPage != null and pageSize != null">
            LIMIT #{startPage,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>

    <select id="queryShelvesReviewMgCount" parameterType="map" resultType="Integer">
        SELECT COUNT (*)
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        <trim prefix="where" prefixOverrides="and|or">
            <if test="id != null">
                AND m.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="auditStatus != null">
                AND p.review_status =#{auditStatus,jdbcType=INTEGER}
            </if>
            <if test="shelveStatus != null">
                AND p.shelves_status =#{shelveStatus,jdbcType=INTEGER}
            </if>
        </trim>

    </select>

    <select id="getProductReviewDetail" parameterType="java.lang.Integer" resultType="com.kshl.huihuimall.console.base.pojo.ProductDetailPojo">
        SELECT *
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        WHERE id=#{productid,jdbcType=INTEGER}
    </select>

    <update id="putOnTheShelfSelf" parameterType="com.kshl.huihuimall.base.dal.entity.Product">
        update product set
        shelves_status = 1,
        shelves_date=#{shelvesDate}
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="putOnTheShelfThird" parameterType="com.kshl.huihuimall.base.dal.entity.Product">
        update product set
        shelves_status =#{shelvesStatus},
        shelves_date=#{shelvesDate}
        where id = #{id,jdbcType=INTEGER}
    </update>

    <update id="putOffTheShelf" parameterType="com.kshl.huihuimall.base.dal.entity.Product">
        update product set
        shelves_status = 2,
        offshelves_date=#{offshelvesDate}
        where id = #{id,jdbcType=INTEGER}
    </update>

    <select id="ProductDetailById" parameterType="map" resultType="map">
        SELECT
        p.*, b.name AS brandname, b.id as brandid, co.name AS categoryonename ,
        co.id as categoryoneid , ct.name AS categorytwoname  ,ct.id as  categorytwoid
        FROM product AS p
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id where p.id=#{id}
    </select>

    <select id="getProductByCode" parameterType="java.lang.String" resultMap="ProductBaseResultMap">
        SELECT p.*
        FROM product AS p
        WHERE  p.code= #{code}
    </select>

    <update id="updateProductByKey" parameterType="com.kshl.huihuimall.base.dal.entity.Product">
        update product
        set shelves_status = #{shelvesStatus,jdbcType=INTEGER},
        offshelves_date = #{offshelvesDate,jdbcType=TIMESTAMP},
        shelves_date = #{shelvesDate,jdbcType=TIMESTAMP},
        categoryone_id = #{categoryoneId,jdbcType=INTEGER},
        categorytwo_id = #{categorytwoId,jdbcType=INTEGER},
        code = #{code,jdbcType=VARCHAR},
        name = #{name,jdbcType=VARCHAR},
        brand_id = #{brandId,jdbcType=INTEGER},
        specifications = #{specifications,jdbcType=VARCHAR},
        measurement_unit = #{measurementUnit,jdbcType=VARCHAR},
        packing = #{packing,jdbcType=VARCHAR},
        weight = #{weight,jdbcType=VARCHAR},
        purchase_price = #{purchasePrice,jdbcType=DECIMAL},
        packing_price = #{packingPrice,jdbcType=DECIMAL},
        material_price = #{materialPrice,jdbcType=DECIMAL},
        transport_price = #{transportPrice,jdbcType=DECIMAL},
        place_of_origin = #{placeOfOrigin,jdbcType=VARCHAR},
        price = #{price,jdbcType=DECIMAL},
        trade_price = #{tradePrice,jdbcType=DECIMAL},
        stock_location = #{stockLocation,jdbcType=INTEGER},
        main_image_path = #{mainImagePath,jdbcType=VARCHAR},
        merchant_id = #{merchantId,jdbcType=INTEGER},
        review_status = #{reviewStatus,jdbcType=INTEGER},
        merchant_type = #{merchantType,jdbcType=INTEGER},
        date_manufacture = #{dateManufacture,jdbcType=TIMESTAMP},
        guarantee_date = #{guaranteeDate,jdbcType=INTEGER},
        expiration_date = #{expirationDate,jdbcType=TIMESTAMP},
        Remarks = #{remarks,jdbcType=VARCHAR},
        detail_image_path = #{detailImagePath,jdbcType=LONGVARCHAR}
        where id = #{id,jdbcType=INTEGER}
    </update>


    <select id="getThirdPartyProduct" parameterType="map" resultType="map">
        SELECT
        p.*, b.name AS brandname, co.name AS categoryonename, ct.name AS categorytwoname,
        m.name AS merchantname
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        join ks_account as a on a.merchant_code=m.ent_code
        WHERE p.merchant_type=1
        <if test="accountId != 1">
            and a.id=#{accountId}
        </if>
        <if test="shelvesStatus != null">
            AND p.shelves_status = #{shelvesStatus}
        </if>
        <if test="name != null">
            AND p.name LIKE CONCAT('%','${name}', '%')
        </if>
        <if test="reviewStatus != null">
            AND p.review_status = #{reviewStatus}
        </if>
        ORDER BY FIELD (p.shelves_status,1,0,2) ,p.shelves_date desc
        <if test="startPage != null and pageSize != null">
            LIMIT #{startPage,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>

    <select id="getThirdPartyProductCount" parameterType="map" resultType="Integer">
        SELECT
        COUNT(*)
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        join ks_account as a on a.merchant_code=m.ent_code
        WHERE p.merchant_type=1
        <if test="accountId != 1">
            and a.id=#{accountId}
        </if>
        <if test="shelvesStatus != null">
            AND p.shelves_status = #{shelvesStatus}
        </if>
        <if test="name != null">
            AND p.name LIKE CONCAT('%','${name}', '%')
        </if>
        <if test="reviewStatus != null">
            AND p.review_status = #{reviewStatus}
        </if>
    </select>
    <!--   商品审核申请（更改审核状态），商品上架审核（通过更改审核、上架状态）  -->
    <update id="selfServiceReview" parameterType="com.kshl.huihuimall.base.dal.entity.Product">
        update product set review_status=#{reviewStatus}
        <if test="shelvesStatus != null">
            ,shelves_status = #{shelvesStatus}
            ,review_time=#{reviewTime}
        </if>
        where id=#{id}
    </update>

    <select id="getselfServiceReviewProduct" parameterType="map" resultType="map">
        SELECT
        p.*, b.name AS brandname, co.name AS categoryonename, ct.name AS categorytwoname,
        m.name AS merchantname
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        WHERE p.merchant_type=1 and p.review_status=1
        <if test="mername != null">
            AND m.name LIKE CONCAT('%','${mername}', '%')
        </if>
        <if test="startPage != null and pageSize != null">
            LIMIT #{startPage,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>

    <select id="getselfServiceReviewProductCount" parameterType="map" resultType="Integer">
        SELECT
        COUNT(*)
        FROM product AS p
        LEFT JOIN merchant AS m ON m.id = p.merchant_id
        LEFT JOIN category_one AS co ON co.id = p.categoryone_id
        LEFT JOIN category_two AS ct ON ct.id = p.categorytwo_id
        LEFT JOIN brand AS b ON b.id = p.brand_id
        WHERE p.merchant_type=1 and p.review_status=1
        <if test="mername != null">
            AND m.name LIKE CONCAT('%','${mername}', '%')
        </if>
    </select>


    <select id="getPrductPrices" parameterType="java.lang.String" resultType="com.kshl.huihuimall.base.dal.entity.Product">
        select purchase_price as purchasePrice,material_price as materialPrice,packing_price as packingPrice,
        transport_price as transportPrice,trade_price as tradePrice,`name` from product
        where `code` =#{code}
    </select>


</mapper>