<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kshl.huihuimall.console.dal.manualmapper.OrderManualMapper">

    <resultMap id="StoreOrderBaseResultMap" type="com.kshl.huihuimall.base.dal.entity.StoreOrder">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id" />
        <result column="order_number" jdbcType="VARCHAR" property="orderNumber" />
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
        <result column="sales" jdbcType="DECIMAL" property="sales" />
        <result column="profits" jdbcType="DECIMAL" property="profits" />
        <result column="type" jdbcType="VARCHAR" property="type" />
        <result column="orderstatus" jdbcType="VARCHAR" property="orderstatus" />
        <result column="merchantname" jdbcType="VARCHAR" property="merchantname" />
        <result column="storename" jdbcType="VARCHAR" property="storename" />
        <result column="storeaddress" jdbcType="VARCHAR" property="storeaddress" />
        <result column="parent_id" jdbcType="VARCHAR" property="parentId" />
        <result column="store_id" jdbcType="INTEGER" property="storeId" />
        <result column="recom_store_id" jdbcType="INTEGER" property="recomStoreId" />
        <result column="storehouse_id" jdbcType="INTEGER" property="storehouseId" />
        <result column="shopkeeper_id" jdbcType="INTEGER" property="shopkeeperId" />
        <result column="user_id" jdbcType="VARCHAR" property="userId" />
    </resultMap>

    <resultMap id="OrderDetailBaseResultMap" type="com.kshl.huihuimall.base.dal.entity.OrderDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id" />
        <result column="productname" jdbcType="VARCHAR" property="productname" />
        <result column="number" jdbcType="INTEGER" property="number" />
        <result column="total" jdbcType="DECIMAL" property="total" />
        <result column="order_number" jdbcType="VARCHAR" property="orderNumber" />
    </resultMap>

    <resultMap id="ReturnExchangeBaseResultMap" type="com.kshl.huihuimall.base.dal.entity.ReturnExchangeOrder">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id" />
        <result column="order_number" jdbcType="VARCHAR" property="orderNumber" />
        <result column="store_id" jdbcType="INTEGER" property="storeId" />
        <result column="order_time" jdbcType="TIMESTAMP" property="orderTime" />
        <result column="type" jdbcType="INTEGER" property="type" />
        <result column="product_id" jdbcType="INTEGER" property="productId" />
        <result column="count" jdbcType="DECIMAL" property="count" />
        <result column="store_name" jdbcType="VARCHAR" property="storeName" />
        <result column="order_type" jdbcType="VARCHAR" property="orderType" />
        <result column="return_status" jdbcType="INTEGER" property="returnStatus" />
        <result column="audit_status" jdbcType="INTEGER" property="auditStatus" />
        <result column="exchange_status" jdbcType="INTEGER" property="exchangeStatus" />
        <result column="warehouse_id" jdbcType="INTEGER" property="warehouseId" />
        <result column="product_name" jdbcType="VARCHAR" property="productName" />
        <result column="order_id" jdbcType="VARCHAR" property="orderId" />
    </resultMap>

    <resultMap id="OrderProductDetailBaseResultMap" type="com.kshl.huihuimall.console.base.pojo.OrderProductPojo">
        <id column="store_id" jdbcType="INTEGER" property="storeId" />
        <result column="profit" jdbcType="DECIMAL" property="profit" />
    </resultMap>

    <resultMap id="OrderProfitBaseResultMap" type="com.kshl.huihuimall.console.base.pojo.ProfitPojo">
        <result column="order_number" jdbcType="VARCHAR" property="orderNumber" />
        <result column="phone_number" jdbcType="VARCHAR" property="phoneNumber" />
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
        <result column="total" jdbcType="DECIMAL" property="total" />
        <result column="profit" jdbcType="DECIMAL" property="profit" />
        <result column="recommend" jdbcType="DECIMAL" property="recommend" />
        <result column="consumption" jdbcType="DECIMAL" property="consumption" />
    </resultMap>

    <select id="getAllOrder" parameterType="map" resultType="map">
        SELECT p.*, cu.id AS cid,cu.store_id AS recomstore,cu.recommend_person_id,
        cu.phone_number ,cu.open_id
        FROM store_order AS p
        LEFT JOIN customer AS cu ON p.user_id = cu.id
        <trim prefix="where" prefixOverrides="and|or">
            <if test="type != null">
                AND p.type= #{type}
            </if>
            <if test="orderstatus != null">
                AND p.orderstatus = #{orderstatus}
            </if>
            <if test="orderNumber != null">
                AND p.order_number = #{orderNumber}
            </if>
            <if test="storename != null">
                AND p.storename LIKE CONCAT('%', #{storename}, '%')
            </if>
           <if test="startTime!=null and startTime!=''">
            <if test="endTime!=null and endTime!=''">
               AND p.start_time BETWEEN DATE_FORMAT(#{startTime}, '%Y-%m-%d %H:%i:%S') AND DATE_FORMAT(#{endTime}, '%Y-%m-%d %H:%i:%S')
            </if>
            </if>
            <if test="entCode != null">
                AND p.ent_code = #{entCode}
            </if>
            <if test="merchantname != null">
                AND p.merchantname LIKE CONCAT('%', #{merchantname}, '%')
            </if>
        </trim>
        <if test="startPage != null and pageSize != null">
            LIMIT #{startPage,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>

    <select id="getAllOrderCount" parameterType="map" resultType="java.lang.Integer">
        SELECT COUNT(p.id)
        FROM store_order AS p
        LEFT JOIN customer AS cu ON p.user_id = cu.id
        <trim prefix="where" prefixOverrides="and|or">
            <if test="type != null">
                AND p.type= #{type}
            </if>
            <if test="orderstatus != null">
                AND p.orderstatus = #{orderstatus}
            </if>
            <if test="orderNumber != null">
                AND p.order_number = #{orderNumber}
            </if>
            <if test="storename != null">
                AND p.storename LIKE CONCAT('%', #{storename}, '%')
            </if>
            <if test="startTime!=null and startTime!=''">
                <if test="endTime!=null and endTime!=''">
                    AND p.start_time BETWEEN DATE_FORMAT(#{startTime}, '%Y-%m-%d %H:%i:%S') AND DATE_FORMAT(#{endTime}, '%Y-%m-%d %H:%i:%S')
                </if>
            </if>
            <if test="entCode != null">
                AND p.ent_code = #{entCode}
            </if>
            <if test="merchantname != null">
                AND p.merchantname LIKE CONCAT('%', #{merchantname}, '%')
            </if>
        </trim>

    </select>

    <select id="getOrderByOrderNumber" parameterType="java.lang.String" resultMap="StoreOrderBaseResultMap">
        SELECT p.*
        FROM store_order AS p
        WHERE  p.order_number= #{orderNumber}

    </select>

   <select id="getOrderDetail" parameterType="java.lang.String" resultMap="OrderDetailBaseResultMap">
        SELECT o.*
        FROM order_detail AS o
        WHERE  o.order_number= #{orderNumber}

    </select>

    <select id="sendOrder" parameterType="map" resultType="map">
        SELECT p.*  FROM store_order AS p
        <trim prefix="where" prefixOverrides="and|or">

            <if test="orderstatus != null">
                AND p.orderstatus = #{orderstatus}
            </if>
            <if test="orderNumber != null">
                AND p.order_number = #{orderNumber}
            </if>
            <if test="storename != null">
                AND p.storename LIKE CONCAT('%', #{storename}, '%')
            </if>
        </trim>
        <if test="startPage != null and pageSize != null">
            LIMIT #{startPage,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>

    <select id="getAllsendOrder" parameterType="map" resultType="java.lang.Integer">
        SELECT COUNT(p.id)
        FROM store_order AS p
        <trim prefix="where" prefixOverrides="and|or">
            <if test="orderstatus != null">
                AND p.orderstatus = #{orderstatus}
            </if>
            <if test="orderNumber != null">
                AND p.order_number = #{orderNumber}
            </if>
            <if test="storename != null">
                AND p.storename LIKE CONCAT('%', #{storename}, '%')
            </if>
        </trim>

    </select>

    <select id="queryReturnExchangeOrder" parameterType="map" resultType="map">
        SELECT p.*  FROM return_exchange_order AS p
        <trim prefix="where" prefixOverrides="and|or">
            <if test="type != null">
                AND p.type= #{type}
            </if>

            <if test="orderNumber != null">
                AND p.order_number = #{orderNumber}
            </if>
            <if test="storeName != null">
                AND p.store_name LIKE CONCAT('%', #{storeName}, '%')
            </if>
            <if test="orderType != null">
                AND p.order_type = #{orderType}
            </if>
            <if test="auditStatus != null">
                AND p.audit_status = #{auditStatus}
            </if>

            <if test="returnStatus != null">
                AND p.return_status = #{returnStatus}
            </if>
            <if test="exchangeStatus != null">
                OR p.exchange_status = #{exchangeStatus}
            </if>
        </trim>
        <if test="startPage != null and pageSize != null">
            LIMIT #{startPage,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>

    <select id="queryReturnExchangeOrderCount" parameterType="map" resultType="java.lang.Integer">
        SELECT COUNT(p.id)
        FROM return_exchange_order AS p
        <trim prefix="where" prefixOverrides="and|or">
            <if test="type != null">
                AND p.type= #{type}
            </if>
            <if test="orderNumber != null">
                AND p.order_number = #{orderNumber}
            </if>
            <if test="storeName != null">
                AND p.store_name LIKE CONCAT('%', #{storeName}, '%')
            </if>
            <if test="orderType != null">
                AND p.order_type = #{orderType}
            </if>
            <if test="auditStatus != null">
                AND p.audit_status = #{auditStatus}
            </if>

            <if test="returnStatus != null">
                AND p.return_status = #{returnStatus}
            </if>
            <if test="exchangeStatus != null">
                OR p.exchange_status = #{exchangeStatus}
            </if>
        </trim>

    </select>

    <select id="getRExchangeOrderByOrderNumber" parameterType="java.lang.String" resultMap="ReturnExchangeBaseResultMap">
        SELECT p.*
        FROM return_exchange_order AS p
        WHERE  p.order_number= #{orderNumber}
    </select>

    <select id="getOrderById" parameterType="java.lang.String" resultType="com.kshl.huihuimall.base.dal.entity.StoreOrder">
        SELECT *FROM store_order where order_number LIKE CONCAT('%', #{orderid}, '%')
    </select>

    <select id="queryOutInventory" parameterType="map" resultType="map">
        SELECT * FROM store_order as so
        LEFT JOIN inventory_out AS io ON so.order_number = io.order_number
        LEFT JOIN storehouse AS sh ON so.storehouse_id = sh.id
        LEFT JOIN order_detail AS od ON so.order_number = od.order_number
        <trim prefix="where" prefixOverrides="and|or">
          <if test="orderstatus!=null">
              AND so.orderstatus=#{orderstatus,jdbcType=INTEGER}
          </if>
           <if test="type!=null">
                AND so.type=#{type,jdbcType=INTEGER}
           </if>
            <if test="StorehouserId!=null">
                AND so.storehouse_id=#{StorehouserId,jdbcType=INTEGER}
            </if>
            <if test="code!=null">
                AND io.code=#{code,jdbcType=INTEGER}
            </if>
            <if test="status!=null">
                AND io.status=#{status,jdbcType=INTEGER}
            </if>
            <if test="orderStatus!=null">
                AND so.orderstatus=#{orderStatus,jdbcType=INTEGER}
            </if>
            <if test="storeHouse!=null">
                AND sh.storehouse_name=#{storeHouse,jdbcType=INTEGER}
            </if>
            <if test="startTime!=null and startTime!=''">
                <if test="endTime!=null and endTime!=''">
                    AND so.start_time BETWEEN DATE_FORMAT(#{startTime}, '%Y-%m-%d %H:%i:%S') AND DATE_FORMAT(#{endTime}, '%Y-%m-%d %H:%i:%S')
                </if>
            </if>
        </trim>
        <if test="startPage != null and pageSize != null">
            LIMIT #{startPage,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>
    
    <select id="queryOutInventoryCount" parameterType="map" resultType="Integer">
        SELECT COUNT (*) FROM store_order as so
        LEFT JOIN inventory_out AS io ON so.order_number = io.order_number
        LEFT JOIN storehouse AS sh ON so.storehouse_id = sh.id
        LEFT JOIN order_detail AS od ON so.order_number = od.order_number
        <trim prefix="where" prefixOverrides="and|or">
            <if test="orderstatus!=null">
                AND so.orderstatus=#{orderstatus,jdbcType=INTEGER}
            </if>
            <if test="type!=null">
                AND so.type=#{type,jdbcType=INTEGER}
            </if>
            <if test="StorehouserId!=null">
                AND so.storehouse_id=#{StorehouserId,jdbcType=INTEGER}
            </if>
            <if test="code!=null">
                AND io.code=#{code,jdbcType=INTEGER}
            </if>
            <if test="status!=null">
                AND io.status=#{status,jdbcType=INTEGER}
            </if>
            <if test="orderStatus!=null">
                AND so.orderstatus=#{orderStatus,jdbcType=INTEGER}
            </if>
            <if test="storeHouse!=null">
                AND sh.storehouse_name=#{storeHouse,jdbcType=INTEGER}
            </if>
            <if test="startTime!=null and startTime!=''">
                <if test="endTime!=null and endTime!=''">
                    AND so.start_time BETWEEN DATE_FORMAT(#{startTime}, '%Y-%m-%d %H:%i:%S') AND DATE_FORMAT(#{endTime}, '%Y-%m-%d %H:%i:%S')
                </if>
            </if>
        </trim>
    </select>

    <update id="updateStoreOrder" parameterType="com.kshl.huihuimall.base.dal.entity.StoreOrder">
      update store_order
        SET orderstatus = #{orderstatus,jdbcType=VARCHAR}
      where order_number = #{orderNumber,jdbcType=VARCHAR}
    </update>

    <select id="getOrderProductDetail" parameterType="java.lang.String" resultMap="OrderProductDetailBaseResultMap">
        SELECT
            so.store_id,
            (
                (
                    IFNULL(pt.purchase_price, 0) - IFNULL(pt.packing_price, 0) - IFNULL(pt.material_price, 0) - IFNULL(pt.transport_price, 0)
                ) * IFNULL(od.number, 0)
            ) AS profit
        FROM
            store_order AS so
        LEFT JOIN order_detail AS od ON od.order_number = so.order_number
        LEFT JOIN product AS pt ON pt. CODE = od. CODE
        WHERE
            so.order_number = #{orderNumber}
    </select>

    <select id="getOrderProfit" parameterType="java.lang.Integer" resultMap="OrderProfitBaseResultMap">
         SELECT
        so.order_number,
        sp.phone_number,
        so.start_time,
        SUM(od.total) AS total,
            so.store_id,
        (
            (
                IFNULL(pt.purchase_price, 0) - IFNULL(pt.packing_price, 0) - IFNULL(pt.material_price, 0) - IFNULL(pt.transport_price, 0)
            ) * IFNULL(od.number, 0)
        ) AS profit
    FROM
        store_order AS so
    LEFT JOIN order_detail AS od ON od.order_number = so.order_number
    LEFT JOIN shopkeeper AS sp ON sp.store_id = so.store_id
    LEFT JOIN product AS pt ON pt. CODE = od. CODE
    WHERE
        so.store_id = #{storeId,jdbcType=INTEGER}
                AND so.start_time BETWEEN DATE_FORMAT(#{startTime}, '%Y-%m-%d %H:%i:%S') AND DATE_FORMAT(#{endTime}, '%Y-%m-%d %H:%i:%S')
    GROUP BY
        order_number
    </select>

</mapper>